# ì±„íŒ…ì•± ë§Œë“¤ê¸° Day 3 - í´ë¼ì´ì–¸íŠ¸ ë° ì„œë²„ êµ¬í˜„ - 2

ìƒì„±ì¼: 2025ë…„ 3ì›” 25ì¼ ì˜¤í›„ 5:15

ì‘ì„±ì¼: 25.03.25

## 1. êµ¬í˜„í•œ ê¸°ëŠ¥

- ì±„íŒ…ë°© ì ‘ì† ì‹œ ë‹‰ë„¤ì„ ì„¤ì •í•˜ëŠ” ê¸°ëŠ¥(with ëª¨ë‹¬)
- ì±„íŒ…ì°½ ë§í’ì„ ì— ë‹‰ë„¤ì„ í‘œì‹œ
- ì±„íŒ… ì°¸ì—¬ì ìˆ˜ ë° ì°¸ì—¬ì ëª©ë¡ ì‹¤ì‹œê°„ìœ¼ë¡œ ìˆ˜ì •
- ì±„íŒ… ì°¸ì—¬ì ë¦¬ìŠ¤íŠ¸ì°½ì— ë³¸ì¸ì˜ ë‹‰ë„¤ì„ ë” ê°•ì¡°ë˜ë„ë¡ ë³€ê²½

## 2. ì½”ë“œ

1. í´ë¼ì´ì–¸íŠ¸
    - ì½”ë“œ ë³´ê¸°
        1. client.html
            
            ```jsx
            <!DOCTYPE html>
            <html lang="ko">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>ì±„íŒ… ì• í”Œë¦¬ì¼€ì´ì…˜</title>
                <link rel="stylesheet" href="client.css">
                <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
            </head>
            <body>
                <!-- ë‹‰ë„¤ì„ ì„¤ì • ëª¨ë‹¬ -->
                <div id="nicknameModal" class="modal">
                    <div class="modal-content">
                        <h2>ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”</h2>
                        <input type="text" id="nicknameInput" placeholder="ë‹‰ë„¤ì„">
                        <button id="submitNickname" onclick="connectWebSocket()">í™•ì¸</button>
                    </div>
                </div>
                <div class="container">
                    <!-- ì‚¬ì´ë“œë°” - ì°¸ê°€ì ëª©ë¡ -->
                    <div class="sidebar">
                        <div class="user-profile">
                            <img src="default-avatar.png" alt="í”„ë¡œí•„" class="profile-img">
                            <span class="username" id="username">ì‚¬ìš©ì ì´ë¦„</span>
                        </div>
                        <h3>ì°¸ê°€ì ëª©ë¡</h3>
                        <ul class="participants-list" id="participantsList">
                            <!-- ì°¸ê°€ìë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                        </ul>
                    </div>
            
                    <!-- ë©”ì¸ ì±„íŒ… ì˜ì—­ -->
                    <div class="main-content">
                        <!-- ì±„íŒ…ë°© ì •ë³´ -->
                        <div class="chat-header">
                            <h2>ì±„íŒ…ë°© ì´ë¦„</h2>
                            <div class="chat-info">
                                <span class="participant-count">ì°¸ê°€ì: </span>
                                <span class="participant-count" id="userNumber">0</span>
                            </div>
                        </div>
            
                        <!-- ì±„íŒ… ë©”ì‹œì§€ ì˜ì—­ -->
                        <div class="chat-messages" id="chatMessages">
                            <!-- ë©”ì‹œì§€ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                        </div>
            
                        <!-- ë©”ì‹œì§€ ì…ë ¥ ì˜ì—­ -->
                        <div class="message-input-area">
                            <input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
                            <button id="sendButton">ì „ì†¡</button>
                            <button id="fileButton" class="file-button">ğŸ“</button>
                        </div>
                    </div>
                </div>
                <script src="client.js"></script>
            </body>
            </html>
            ```
            
        2. client.css
            
            ```css
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            
            body {
                font-family: 'Noto Sans KR', sans-serif;
                background-color: #f5f5f5;
            }
            
            .modal {
                display: block;
                position: fixed;
                z-index: 1000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
            }
            
            .modal-content {
                background-color: white;
                margin: 15% auto;
                padding: 20px;
                border-radius: 5px;
                width: 300px;
                text-align: center;
            }
            
            .modal-content h2 {
                margin-bottom: 20px;
            }
            
            .modal-content input {
                width: 80%;
                padding: 10px;
                margin-bottom: 15px;
                border: 1px solid #ddd;
                border-radius: 4px;
            }
            
            .modal-content button {
                padding: 10px 20px;
                background-color: #4CAF50;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }
            
            .modal-content button:hover {
                background-color: #45a049;
            }
            
            .container {
                display: flex;
                height: 100vh;
                max-width: 1200px;
                margin: 0 auto;
                background-color: white;
            }
            
            /* ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ë§ */
            .sidebar {
                width: 250px;
                background-color: #2c3e50;
                color: white;
                padding: 20px;
            }
            
            .user-profile {
                display: flex;
                align-items: center;
                margin-bottom: 20px;
                padding-bottom: 20px;
                border-bottom: 1px solid #34495e;
            }
            
            .profile-img {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                margin-right: 10px;
            }
            
            .participants-list {
                list-style: none;
            }
            
            .participant {
                background-color: white;
                color: black;
                padding: 5px 10px;
                border-radius: 5px;
            }
            
            .participants-list li {
                padding: 10px 0;
                display: flex;
                align-items: center;
            }
            
            /* ë©”ì¸ ì±„íŒ… ì˜ì—­ ìŠ¤íƒ€ì¼ë§ */
            .main-content {
                flex: 1;
                display: flex;
                flex-direction: column;
            }
            
            .chat-header {
                padding: 20px;
                background-color: #f8f9fa;
                border-bottom: 1px solid #dee2e6;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .chat-messages {
                flex: 1;
                padding: 20px;
                overflow-y: auto;
            }
            
            .message {
                margin-bottom: 15px;
                padding: 10px;
                border-radius: 10px;
                max-width: 70%;
            }
            
            .message.received {
                background-color: #f1f0f0;
                text-align: left;
            }
            
            .message.sent {
                background-color: #007bff;
                color: white;
                text-align: right;
            }
            
            .message-input-area {
                padding: 20px;
                border-top: 1px solid #dee2e6;
                display: flex;
                gap: 10px;
            }
            
            #messageInput {
                flex: 1;
                padding: 10px;
                border: 1px solid #dee2e6;
                border-radius: 5px;
            }
            
            button {
                padding: 10px 20px;
                border: none;
                border-radius: 5px;
                background-color: #007bff;
                color: white;
                cursor: pointer;
            }
            
            button:hover {
                background-color: #0056b3;
            }
            
            .file-button {
                padding: 10px 15px;
                font-size: 20px;
            }
            ```
            
        3. client.js
            
            ```jsx
            const USER = {
                name: "user" + Math.random()
            }
            
            const SOCKET = {
                socket: null,
            
                connect: function() {
                    socket = new WebSocket('ws://localhost:12345');  // ì„œë²„ ì£¼ì†Œì™€ í¬íŠ¸ ì„¤ì •
                    socket.onopen = SOCKET.onopen;
                    socket.onmessage = SOCKET.onmessage;
                    // ì „ì†¡ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
                    document.getElementById("sendButton").addEventListener("click", SOCKET.sendMessage);
                },
            
                onopen: function() {
                    console.log("WebSocket ì—°ê²° ì„±ê³µ");
                    socket.send(JSON.stringify(USER));
                },
            
                onmessage: function(event) {
                    const json = JSON.parse(event.data);
            
                    if (json.hasOwnProperty("userNumber") && json.hasOwnProperty("userNames")) {
                        document.getElementById("userNumber").textContent = json.userNumber;
            
                        const participantsList = document.getElementById("participantsList");
                        let users = "";
                        json.userNames.forEach(name => {
                            if (name == USER.name) {
                                users += "<li class='participant'> ë‚˜: " + name + "</li>";
                            } else {
                                users += "<li>" + name + "</li>";
                            }
                        });
                        participantsList.innerHTML = users;
                        return;
                    }
            
                    if (json.hasOwnProperty("name") && json.hasOwnProperty("message")) {
                        const chatMessages = document.getElementById("chatMessages");
                        let newMessage = "<div class='message received'>" + json.name + ": " + json.message + "</div>";
                        chatMessages.innerHTML += newMessage;
                        return;
                    }
                },
            
                sendMessage: function() {
                    data = {};
                    data.message = document.getElementById("messageInput").value;  // ì…ë ¥ëœ ë©”ì‹œì§€ ê°€ì ¸ì˜¤ê¸°
                    socket.send(JSON.stringify(data));  // ë©”ì‹œì§€ ì „ì†¡
                    document.getElementById("messageInput").value = "";  // ì…ë ¥ì°½ ì´ˆê¸°í™”
                
                    let selfMessage = "<div class='message sent'>" + 'ë‚˜: ' + data.message + "</div>";
                    let chatMessages = document.getElementById("chatMessages");
                    chatMessages.innerHTML += selfMessage;
                }
            }
            
            function connectWebSocket() {
                const modal = document.getElementById('nicknameModal');
                const nicknameInput = document.getElementById('nicknameInput');
            
                const nickname = nicknameInput.value.trim();
                if (nickname) {
                    // ë‹‰ë„¤ì„ì„ ì €ì¥í•˜ê³  ëª¨ë‹¬ ë‹«ê¸°
                    USER.name = nickname;
                    document.getElementById('username').textContent = nickname;
                    modal.style.display = 'none';
                } else {
                    alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                }
            
                SOCKET.connect();
            }
            ```
            
            - ë‹‰ë„¤ì„ì„ ì…ë ¥ í›„, ì„œë²„ì— ì—°ê²°í•˜ëŠ” ìˆœì„œë¥¼ ì§€í‚¤ê¸° ìœ„í•´ `connectWebSocket()`ì´ë¼ëŠ” ë©”ì†Œë“œ ìƒì„±
            - `JSON.parse()` : jsonë¬¸ìì—´ì„ javascriptê°ì²´ë¡œ ë³€í™˜
            - `hasOwnProperty("í”„ë¡œí¼í‹°ëª…")` : javascriptê°ì²´ì— í•´ë‹¹ í”„ë¡œí¼í‹°(í•„ë“œ)ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
2. ì„œë²„
    - ì½”ë“œ ë³´ê¸°
        1. ChatServer.java
            
            ```java
            package chat;
            
            import java.net.InetSocketAddress;
            import java.util.ArrayList;
            import java.util.HashMap;
            import java.util.Iterator;
            import java.util.List;
            import java.util.Map;
            import java.util.concurrent.CopyOnWriteArrayList;
            
            import org.java_websocket.WebSocket;
            import org.java_websocket.handshake.ClientHandshake;
            import org.java_websocket.server.WebSocketServer;
            
            import com.fasterxml.jackson.core.JsonProcessingException;
            import com.fasterxml.jackson.databind.JsonMappingException;
            import com.fasterxml.jackson.databind.ObjectMapper;
            
            public class ChatServer extends WebSocketServer {
            
                private static final String SERVER_ADDRESS = "127.0.0.1"; // ì„œë²„ IP ì£¼ì†Œ
                private static final int PORT = 12345;  // ì„œë²„ í¬íŠ¸ ë²ˆí˜¸
                
                // => ì¼ë°˜ Listë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šì€ ì´ìœ : í–¥ìƒëœ forë¬¸ìœ¼ë¡œ ëŒë ¤ì„œ ìš”ì†Œë¥¼ ì œê±°í•˜ë©´ ConcurrentModificationException ì˜¤ë¥˜ ë°œìƒ
                // => í•´ê²°ë°©ë²•: 1. Iteratorë¥¼ í†µí•´ ìš”ì†Œ ì¶”ê°€ ë° ì‚­ì œ / 2. CopyOnWriteArrayList í™œìš©
                // private CopyOnWriteArrayList<User> users; // ì ‘ì† ì¤‘ì¸ ìœ ì €ë¦¬ìŠ¤íŠ¸
                private List<User> users;
            
                public static void main(String[] args) {
                    ChatServer server = new ChatServer(PORT);
                    server.start();
                    System.out.println("ì±„íŒ… ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤...");
                }
            
                public ChatServer(int port) {
                    super(new InetSocketAddress(SERVER_ADDRESS, port));
                }
            
                @Override
                public void onOpen(WebSocket conn, ClientHandshake handshake) {
                	InetSocketAddress isa = (InetSocketAddress) conn.getRemoteSocketAddress();
                    System.out.println("ìƒˆ í´ë¼ì´ì–¸íŠ¸ ì—°ê²°ë¨: " + isa.getAddress().getHostAddress() + ":" + isa.getPort());
                    Map<String, Object> map = new HashMap<>();
                    map.put("message", "ì„œë²„ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤!");
                    try {
            			sendToOne(conn, map);
            		} catch (JsonProcessingException e) {
            			e.printStackTrace();
            		}
                }
            
                @Override
                public void onClose(WebSocket conn, int code, String reason, boolean remote) {
                    System.out.println("í´ë¼ì´ì–¸íŠ¸ ì—°ê²° ì¢…ë£Œ: " + conn.getRemoteSocketAddress());
                    Map<String, Object> participation = new HashMap<>();
                    List<String> userNames = new ArrayList<>();
                    Iterator<User> iterator = users.iterator();
                    while (iterator.hasNext()) {
                    	User u = iterator.next();
                        if (u.getWebSocket() != conn) {
                        	userNames.add(u.getName());
                        	continue;
                        }
                        iterator.remove();
                    }
                    
                    participation.put("userNumber", users.size());
                    participation.put("userNames", userNames);
                    try {
            			sendToAll(participation);
            		} catch (JsonProcessingException e) {
            			e.printStackTrace();
            		}
                }
            
                @Override
                public void onMessage(WebSocket conn, String data) {
                	
                    try {
                        Map<String, Object> map = new HashMap<>();
                        map = jsonToMap(data);
                        
                        if (map.containsKey("name")) {
                            System.out.println("í´ë¼ì´ì–¸íŠ¸ ì´ë¦„: " + map);
                        	String name = (String) map.get("name");
                        	InetSocketAddress isa = (InetSocketAddress) conn.getRemoteSocketAddress();
                            User newUser = new User(name, isa.getAddress().getHostAddress(), isa.getPort(), conn);
                            users.add(newUser);
                            
                            Map<String, Object> participation = new HashMap<>();
                            participation.put("userNumber", users.size());
                            
                            List<String> userNames = new ArrayList<>();
                            for (User user : users) {
                            	userNames.add(user.getName());
                            }
                            participation.put("userNames", userNames);
                            sendToAll(participation);
                            return;
                        }
                        
                        if (map.containsKey("message")) {
                            System.out.println("ë°›ì€ ë©”ì‹œì§€: " + map.get("message"));
                            for (User user : users) {
                                // í˜„ì¬ í´ë¼ì´ì–¸íŠ¸ì—ê²ŒëŠ” ë©”ì‹œì§€ë¥¼ ì „ì†¡í•˜ì§€ ì•ŠìŒ
                                if (user.getWebSocket() != conn) {
                                	map.put("name", user.getName());
                                	sendToOne(user.getWebSocket(), map);
                                }
                            }
                        }
                    } catch (Exception e) {
                        e.printStackTrace();
                        conn.send("ì˜ëª»ëœ í˜•ì‹ì˜ ë©”ì‹œì§€ì…ë‹ˆë‹¤.");
                    }
                }
            
                @Override
                public void onError(WebSocket conn, Exception ex) {
                    ex.printStackTrace();
                }
            
                @Override
                public void onStart() {
                    System.out.println("ì„œë²„ ì‹œì‘ë¨...");
            //        users = new CopyOnWriteArrayList<>();
                    users = new ArrayList<>();
                }
                
                // íŠ¹ì • ìœ ì €ì—ê²Œ ë©”ì‹œì§€ ì „ì†¡
                private void sendToOne(WebSocket conn, Map<String, Object> message) throws JsonProcessingException {
                	String jsonMessage = mapToJson(message);
                	conn.send(jsonMessage);
            	}
                
                // ëª¨ë“  ìœ ì €ì—ê²Œ ë©”ì‹œì§€ ì „ì†¡
                private void sendToAll(Map<String, Object> message) throws JsonProcessingException {
            		for (User user : users) {
            			String jsonMessage = mapToJson(message);
            			user.getWebSocket().send(jsonMessage);
            		}
            	}
                
                private Map<String, Object> jsonToMap(String json) throws JsonMappingException, JsonProcessingException {
            		ObjectMapper objectMapper = new ObjectMapper();
            		return objectMapper.readValue(json, Map.class);
            	}
                
                private String mapToJson(Map<String, Object> map) throws JsonProcessingException {
                	ObjectMapper objectMapper = new ObjectMapper();
                	return objectMapper.writeValueAsString(map);
            	}
            }
            
            ```
            
            - í˜„ì¬ ì±„íŒ…ë°©ì— ì°¸ê°€ ì¤‘ì¸ User ë¦¬ìŠ¤íŠ¸ì—ì„œ ìš”ì†Œë¥¼ ì‚­ì œí•˜ëŠ” ë¡œì§ì„ for-eachë¡œ êµ¬í˜„í•´ì„œ `ConcurrentModificationExcpetion` ì—ëŸ¬ ë°œìƒ
            â‡’ í•´ê²°ë°©ë²•(ì°¸ê³ : [https://m.blog.naver.com/tmondev/220393974518](https://m.blog.naver.com/tmondev/220393974518))
            â‡’ 1. Iterator í™œìš© / 2. CopyOnWriteArrayList í™œìš© / 3. ë“±ë“±â€¦
        
        1. User.java (ì´ì „ê³¼ ë™ì¼)
            
            ```java
            package chat;
            
            import org.java_websocket.WebSocket;
            
            public class User {
                private String name;
                private String ip;
                private int port;
                private WebSocket webSocket;
            
                public User(String name, String ip, int port) {
                    this.name = name;
                    this.ip = ip;
                    this.port = port;
                }
            
                // WebSocket ê°ì²´ë¥¼ ì¶”ê°€í•œ ìƒì„±ì
                public User(String name, String ip, int port, WebSocket webSocket) {
                    this.name = name;
                    this.ip = ip;
                    this.port = port;
                    this.webSocket = webSocket;
                }
            
                public String getName() {
                    return name;
                }
                
                public String getIp() {
                    return ip;
                }
                
                public int getPort() {
                    return port;
                }
            
                public WebSocket getWebSocket() {
                    return webSocket;
                }
            }
            
            ```