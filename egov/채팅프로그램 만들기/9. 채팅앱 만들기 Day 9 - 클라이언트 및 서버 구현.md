# ì±„íŒ…ì•± ë§Œë“¤ê¸° Day 10 - í´ë¼ì´ì–¸íŠ¸ ë° ì„œë²„ êµ¬í˜„ - 9

ìƒì„±ì¼: 2025ë…„ 4ì›” 3ì¼ ì˜¤í›„ 3:04

ì‘ì„±ì¼: 25.04.03

## 1. êµ¬í˜„í•œ ê¸°ëŠ¥

- ì±„íŒ… ë‚´ì—­ ë¶ˆëŸ¬ì˜¤ê¸°
- ì±„íŒ… ë§í’ì„  ìœ„ì— í”„ë¡œí•„ ì¶œë ¥

## 2. ì½”ë“œ

1. í´ë¼ì´ì–¸íŠ¸
    - ì½”ë“œ ë¦¬ìŠ¤íŠ¸
        
        ### ì±„íŒ…ì°½
        
        1. client.html
            - ì½”ë“œ ë³´ê¸°
                
                ```html
                <%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
                <%@ page contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
                <!DOCTYPE html>
                <html lang="ko">
                <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>ì±„íŒ… ì• í”Œë¦¬ì¼€ì´ì…˜</title>
                <link rel="stylesheet" href="/css/client.css">
                <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
                </head>
                <body>
                	<div class="container">
                		<!-- ì‚¬ì´ë“œë°” - ì°¸ê°€ì ëª©ë¡ -->
                		<div class="sidebar">
                			<div class="user-profile">
                				<img src="default-avatar.png" alt="í”„ë¡œí•„" class="profile-img"> <span
                					class="username" id="username">ì‚¬ìš©ì ì´ë¦„</span>
                			</div>
                			<button id="leaveButton" class="leave-button">ë‚˜ê°€ê¸°</button>
                			<h3>ì°¸ê°€ì ëª©ë¡</h3>
                			<ul class="participants-list" id="participantsList">
                				<!-- ì°¸ê°€ìë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                			</ul>
                		</div>
                
                		<!-- ë©”ì¸ ì±„íŒ… ì˜ì—­ -->
                		<div class="main-content">
                			<!-- ì±„íŒ…ë°© ì •ë³´ -->
                			<div class="chat-header">
                				<h2 id="roomName">${roomName}</h2>
                				<div class="chat-info">
                					<span class="participant-count">ì°¸ê°€ì: </span> <span
                						class="participant-count" id="userNumber">0</span>
                				</div>
                			</div>
                
                			<!-- ì±„íŒ… ë©”ì‹œì§€ ì˜ì—­ -->
                			<div class="chat-messages" id="chatMessages">
                				<!-- ë©”ì‹œì§€ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                			</div>
                
                			<!-- ë©”ì‹œì§€ ì…ë ¥ ì˜ì—­ -->
                			<div class="message-input-area">
                				<input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
                				<button id="sendButton" onclick="sendMessage()">ì „ì†¡</button>
                				<button id="fileButton" class="file-button">ğŸ“</button>
                			</div>
                		</div>
                	</div>
                	<script src="/js/socket.js"></script>
                	<script src="/js/client.js"></script>
                	<script src="/js/ajax.js"></script>
                </body>
                </html>
                ```
                
        2. client.css
            - ì½”ë“œ ë³´ê¸°
                
                ```css
                * {
                    margin: 0;
                    padding: 0;
                    box-sizing: border-box;
                }
                
                body {
                    font-family: 'Noto Sans KR', sans-serif;
                    background-color: #f5f5f5;
                }
                
                .container {
                    display: flex;
                    height: 100vh;
                    max-width: 1200px;
                    margin: 0 auto;
                    background-color: white;
                }
                
                .leave-button {
                    width: 90%;
                    margin: 10px auto;
                    padding: 8px;
                    background-color: #ff4444;
                    color: white;
                    border: none;
                    border-radius: 5px;
                    cursor: pointer;
                    display: block;
                }
                
                .leave-button:hover {
                    background-color: #cc0000;
                }
                
                /* ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ë§ */
                .sidebar {
                    width: 250px;
                    background-color: #2c3e50;
                    color: white;
                    padding: 20px;
                }
                
                .user-profile {
                    display: flex;
                    align-items: center;
                    margin-bottom: 20px;
                    padding-bottom: 20px;
                    border-bottom: 1px solid #34495e;
                }
                
                .profile-img {
                    width: 40px;
                    height: 40px;
                    border-radius: 50%;
                    margin-right: 10px;
                }
                
                .participants-list {
                    list-style: none;
                }
                
                .participant {
                    background-color: white;
                    color: black;
                    padding: 5px 10px;
                    border-radius: 5px;
                }
                
                .participants-list li {
                    padding: 10px 0;
                    display: flex;
                    align-items: center;
                }
                
                /* ë©”ì¸ ì±„íŒ… ì˜ì—­ ìŠ¤íƒ€ì¼ë§ */
                .main-content {
                    flex: 1;
                    display: flex;
                    flex-direction: column;
                }
                
                .chat-header {
                    padding: 20px;
                    background-color: #f8f9fa;
                    border-bottom: 1px solid #dee2e6;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }
                
                .chat-messages {
                    flex: 1;
                    padding: 20px;
                    overflow-y: auto;
                }
                
                .messageBox {
                	width: 100%;
                	margin-bottom: 20px;
                }
                
                .mini-profile {
                	height: 30px;
                	margin-bottom: 5px;
                }
                
                .messageBox.received {
                	display: flex;
                	flex-direction: column;
                }
                
                .messageBox.sent {
                	display: flex;
                	flex-direction: column;
                	align-items: flex-end;
                }
                
                .message {
                    padding: 10px;
                    border-radius: 10px;
                    max-width: 47%;
                    word-break: break-all
                }
                
                .message.received {
                    background-color: #f1f0f0;
                    text-align: left;
                }
                
                .message.sent {
                    background-color: #007bff;
                    color: white;
                    text-align: right;
                }
                
                .message-input-area {
                    padding: 20px;
                    border-top: 1px solid #dee2e6;
                    display: flex;
                    gap: 10px;
                }
                
                #messageInput {
                    flex: 1;
                    padding: 10px;
                    border: 1px solid #dee2e6;
                    border-radius: 5px;
                }
                
                button {
                    padding: 10px 20px;
                    border: none;
                    border-radius: 5px;
                    background-color: #007bff;
                    color: white;
                    cursor: pointer;
                }
                
                button:hover {
                    background-color: #0056b3;
                }
                
                .file-button {
                    padding: 10px 15px;
                    font-size: 20px;
                }
                ```
                
        3. client.js
            - ì½”ë“œ ë³´ê¸°
                
                ```jsx
                const USER = {
                	name: sessionStorage.getItem('username'),
                	roomName: document.getElementById('roomName').innerText
                }
                
                document.getElementById('username').innerText = sessionStorage.getItem('username');
                const roomName = USER.roomName;
                
                SOCKET.connect(document.getElementById('roomName').innerText);
                
                document.getElementById('leaveButton').addEventListener('click', function() {
                	if (confirm('ì •ë§ë¡œ ì±„íŒ…ë°©ì„ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                
                		data = {}
                		data.close = true;
                		data.roomName = roomName;
                		data.user = USER;
                		SOCKET.socket.send(JSON.stringify(data));
                
                		// ì›¹ì†Œì¼“ ì—°ê²° ì¢…ë£Œ
                		SOCKET.socket.close();
                		// ë©”ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
                		window.location.href = '/webview/chat';
                	}
                });
                
                SOCKET.init(
                	// onopen
                	() => {
                		console.log("WebSocket ì—°ê²° ì„±ê³µ");
                		SOCKET.socket.send(JSON.stringify(USER));
                	},
                
                	// onmessage
                	(event) => {
                		const json = JSON.parse(event.data);
                		if (json.hasOwnProperty("users")) {
                			document.getElementById("userNumber").textContent = json.users.length;
                
                			const participantsList = document.getElementById("participantsList");
                			let userList = "";
                			json.users.forEach(user => {
                				if (user.name == USER.name) {
                					userList += "<li class='participant'> ë‚˜: " + user.name + "</li>";
                				} else {
                					userList += "<li>" + user.name + "</li>";
                				}
                			});
                			participantsList.innerHTML = userList;
                			return;
                		}
                
                		if (json.hasOwnProperty("name") && json.hasOwnProperty("message")) {
                			let chatMessages = document.getElementById("chatMessages");
                			let message = "";
                			let profile = "<div class='mini-profile'>";
                			profile += "<img src='http://localhost:8081/api/profileImages/" + json.name + "' alt='í”„ë¡œí•„' class='profile-img'>";
                			profile += "<span class='username' id='username'>" + json.name + "</span>";
                			profile += "</div>"
                			if (json.name == USER.name) {
                				message += "<div class='messageBox sent'>";
                				message += profile;
                				let selfMessage = "<div class='message sent'>" + json.message + "</div>";
                				message += selfMessage;
                			} else {
                				message += "<div class='messageBox received'>";
                				message += profile;
                				let newMessage = "<div class='message received'>" + json.message + "</div>";
                				message += newMessage;
                			}
                			message += "</div>"
                			chatMessages.innerHTML += message;
                		}
                	}
                )
                
                function sendMessage() {
                	data = {};
                	data.userName = USER.name;
                	data.roomName = roomName;
                	data.message = document.getElementById("messageInput").value;  // ì…ë ¥ëœ ë©”ì‹œì§€ ê°€ì ¸ì˜¤ê¸°
                	SOCKET.socket.send(JSON.stringify(data));  // ë©”ì‹œì§€ ì „ì†¡
                	document.getElementById("messageInput").value = "";  // ì…ë ¥ì°½ ì´ˆê¸°í™”
                
                	let message = "<div class='messageBox sent'>"
                	let profile = "<div class='mini-profile'>";
                	profile += "<img src='http://localhost:8081/api/profileImages/" + data.userName + "' alt='í”„ë¡œí•„' class='profile-img'>";
                	profile += "<span class='username' id='username'>" + data.userName + "</span>";
                	profile += "</div>"
                	message += profile;
                	let selfMessage = "<div class='message sent'>" + data.message + "</div>";
                	message += selfMessage;
                	message += "</div>"
                	let chatMessages = document.getElementById("chatMessages");
                	chatMessages.innerHTML += message;
                }
                
                /*function getProfileImage() {
                	common.sendAjax('post', '/api/profileImages', USER, function(response, xhr) {
                		return response.imageUri;
                	})
                }*/
                ```
                
        
        ### ì±„íŒ…ë°© ë¦¬ìŠ¤íŠ¸
        
        1. roomlist.html (ì´ì „ê³¼ ë™ì¼)
        2. roomlist.css (ì´ì „ê³¼ ë™ì¼)
        3. roomlist.js (ì´ì „ê³¼ ë™ì¼)
        
        ### ë¡œê·¸ì¸
        
        1. login.html (ì´ì „ê³¼ ë™ì¼)
        2. login.css (ì´ì „ê³¼ ë™ì¼)
        3. login.js (ì´ì „ê³¼ ë™ì¼)
        
        ### ì†Œì¼“
        
        1. socket.js (ì´ì „ê³¼ ë™ì¼)
2. ì„œë²„
    - ì½”ë“œ ë¦¬ìŠ¤íŠ¸
        
        ## Socket
        
        1. ChatServer.java
            - ì½”ë“œ ë³´ê¸°
                
                ```java
                package chat.socket;
                
                import java.io.BufferedReader;
                import java.io.IOException;
                import java.io.StringReader;
                import java.util.HashMap;
                import java.util.List;
                import java.util.Map;
                
                import javax.websocket.OnClose;
                import javax.websocket.OnError;
                import javax.websocket.OnMessage;
                import javax.websocket.OnOpen;
                import javax.websocket.Session;
                import javax.websocket.server.PathParam;
                import javax.websocket.server.ServerEndpoint;
                
                import org.springframework.beans.factory.annotation.Autowired;
                
                import com.fasterxml.jackson.core.JsonProcessingException;
                import com.fasterxml.jackson.databind.ObjectMapper;
                
                import chat.annotation.chat;
                import chat.log.ChattingFileManager;
                import chat.socket.config.ChatServerConfig;
                
                @ServerEndpoint(value = "/chat/{roomName}", configurator = ChatServerConfig.class)
                @chat
                public class ChatServer {
                	
                	@Autowired
                	private ChattingRoomManager chattingRoomManager;
                	
                	@Autowired
                	private ChattingFileManager chattingFileManager;
                
                    @OnOpen
                    public void onOpen(@PathParam("roomName") String roomName, Session session) throws IOException {
                        String clientAddress = session.getRequestURI().getHost();
                        int clientPort = session.getRequestURI().getPort();
                        System.out.println("ìƒˆ í´ë¼ì´ì–¸íŠ¸ ì—°ê²°ë¨: " + clientAddress + ":" + clientPort);
                
                        // í´ë¼ì´ì–¸íŠ¸ê°€ ì—°ê²°ë˜ì—ˆì„ ë•Œ ë©”ì‹œì§€ ì „ì†¡
                        Map<String, Object> map = new HashMap<>();
                        map.put("name", "ì„œë²„");
                        map.put("message", "ì„œë²„ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤!");
                        
                        sendMessage(session, map);
                        
                        String oldChatting = chattingFileManager.readChatting(roomName);
                        if (oldChatting == null || oldChatting.equals("")) {
                        	return;
                        }
                        
                        try (BufferedReader reader = new BufferedReader(new StringReader(oldChatting))) {
                            String line;
                            while ((line = reader.readLine()) != null) {
                            	String arr[] = line.split(":");
                                map.put("name", arr[0]);
                                map.put("message", arr[1]);
                                sendMessage(session, map);
                            }
                        } catch (IOException e) {
                            e.printStackTrace();
                        }
                    }
                
                    @OnClose
                    public void onClose(Session session) throws IOException {
                        System.out.println("í´ë¼ì´ì–¸íŠ¸ ì—°ê²° ì¢…ë£Œ: " + session.getId());
                    }
                
                    @OnMessage
                    public void onMessage(Session session, String data) {
                        try {
                            Map<String, Object> message = jsonToMap(data);
                            String roomName = (String) message.get("roomName");
                            Room room = chattingRoomManager.getChattingRoom(roomName);
                
                            if (message.containsKey("name")) {
                                List<User> users = chattingRoomManager.newClient(message, roomName, session);
                                Map<String, Object> participants = new HashMap<>();
                                participants.put("users", users);
                                sendToAll(users, participants);
                                return;
                            }
                
                            if (message.containsKey("message")) {
                            	message.put("name", message.get("userName"));
                            	chattingFileManager.saveChatting(roomName, message.get("userName") + ":" + message.get("message"));
                                for (User user : room.getParticipatns()) {
                                    if (user.getSession() != session) {
                                        sendMessage(user.getSession(), message);
                                    }
                                }
                                return;
                            }
                            
                            if (message.containsKey("close")) {
                            	List<User> users = chattingRoomManager.removeUser(session, roomName);
                                Map<String, Object> participants = new HashMap<>();
                                participants.put("users", users);
                                sendToAll(users, participants);
                            }
                        } catch (Exception e) {
                            e.printStackTrace();
                            try {
                                session.getBasicRemote().sendText("ì˜ëª»ëœ í˜•ì‹ì˜ ë©”ì‹œì§€ì…ë‹ˆë‹¤.");
                            } catch (IOException ex) {
                                ex.printStackTrace();
                            }
                        }
                    }
                
                    @OnError
                    public void onError(Session session, Throwable throwable) {
                        throwable.printStackTrace();
                    }
                
                    // íŠ¹ì • ìœ ì €ì—ê²Œ ë©”ì‹œì§€ ì „ì†¡
                    private void sendMessage(Session session, Map<String, Object> message) throws IOException {
                        String jsonMessage = mapToJson(message);
                        session.getBasicRemote().sendText(jsonMessage);
                    }
                
                    // ëª¨ë“  ìœ ì €ì—ê²Œ ë©”ì‹œì§€ ì „ì†¡
                    private void sendToAll(List<User> users, Map<String, Object> message) {
                        for (User user : users) {
                            try {
                                sendMessage(user.getSession(), message);
                            } catch (IOException e) {
                                e.printStackTrace();
                            }
                        }
                    }
                
                    private Map<String, Object> jsonToMap(String json) {
                        try {
                            ObjectMapper objectMapper = new ObjectMapper();
                            return objectMapper.readValue(json, Map.class);
                        } catch (JsonProcessingException e) {
                            e.printStackTrace();
                            return new HashMap<>();
                        }
                    }
                
                    private String mapToJson(Map<String, Object> map) {
                        try {
                            ObjectMapper objectMapper = new ObjectMapper();
                            return objectMapper.writeValueAsString(map);
                        } catch (JsonProcessingException e) {
                            e.printStackTrace();
                            return "{}";
                        }
                    }
                }
                
                ```
                
                - ì›¹ì†Œì¼“ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë³€ê²½
                - ê·¸ëŸ¬ë‚˜, ì—¬ì „íˆ ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ í†µí•´ ì ‘ê·¼ ì‹œ í†µì‹  ë¶ˆê°€
        2. User.java (ì´ì „ê³¼ ë™ì¼)
        3. Room.java (ì´ì „ê³¼ ë™ì¼)
        4. ChattingRoomManager.java (ì´ì „ê³¼ ë™ì¼)
        5. ChatServerConfig.java (ì´ì „ê³¼ ë™ì¼)
        6. chat(annotation) (ì´ì „ê³¼ ë™ì¼)
        
        ## Log
        
        1. ChattingFileManager
            - ì½”ë“œ ë³´ê¸°
                
                ```java
                package chat.log;
                
                import java.io.BufferedReader;
                import java.io.BufferedWriter;
                import java.io.File;
                import java.io.IOException;
                import java.nio.file.Files;
                import java.nio.file.Path;
                import java.nio.file.Paths;
                import java.nio.file.StandardOpenOption;
                
                import chat.annotation.chat;
                
                @chat
                public class ChattingFileManager {
                	
                	public String readChatting(String roomName) {
                		return read(roomName);
                	}
                	
                	public void saveChatting(String roomName, String data) {
                		write(roomName, data + "\n");
                	}
                	
                    // íŒŒì¼ ì½ê¸°
                	private String read(String roomName) {
                        StringBuilder sb = new StringBuilder();
                        String pathString = "C:/ChattingLog/" + roomName + ".txt";
                        
                        if(isExistFile(pathString)) {
                        	Path path = Paths.get(pathString);
                            try (BufferedReader reader = Files.newBufferedReader(path)) {
                                String line;
                
                                while ((line = reader.readLine()) != null) {
                                    sb.append(line + "\n");
                                }
                                return sb.toString();
                            } catch (IOException e) {
                                e.printStackTrace();
                            }
                        }
                        
                        return null;
                	}
                	
                    // íŒŒì¼ ì“°ê¸°
                	private void write(String roomName, String data) {
                		Path path = Paths.get("C:/ChattingLog/" + roomName + ".txt");
                        try (BufferedWriter writer = Files.newBufferedWriter(path, StandardOpenOption.CREATE, StandardOpenOption.APPEND)) {
                            writer.write(data);
                        } catch (IOException e) {
                            e.printStackTrace();
                        }
                	}
                	
                	private boolean isExistFile(String filePath) {
                        File file = new File(filePath);
                        
                        if (file.exists()) {
                            return true;
                        } else {
                            return false;
                        }
                	}
                }
                
                ```
                
        
        ## API
        
        1. ChatApiController (ì´ì „ê³¼ ë™ì¼)
        2. ChatApiService (ì´ì „ê³¼ ë™ì¼)
        3. ChatApiServiceImpl (ì´ì „ê³¼ ë™ì¼)
        4. ChatApiMapper (ì´ì „ê³¼ ë™ì¼)
        5. ChatApiMapper.xml (ì´ì „ê³¼ ë™ì¼)
        
        ## Webview
        
        1. ChatController (ì´ì „ê³¼ ë™ì¼)
        2. ChatService (ì´ì „ê³¼ ë™ì¼)
        3. ChatServiceImpl (ì´ì „ê³¼ ë™ì¼)
        4. ChatMapper (ì´ì „ê³¼ ë™ì¼)
        5. ChatMapper.xml (ì´ì „ê³¼ ë™ì¼)
3. ê²ªì€ ë¬¸ì œì 